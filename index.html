<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pretix Widget Demo</title>
    <link rel="icon" href="data:,">
    <link rel="stylesheet" type="text/css" href="https://tickets-staging.conferenceconnect.com/conferenceconnect/restoring-pretix-test-2/widget/v1.css" crossorigin />
    <style type="text/css">
        /* Adjust the following CSS variables to personalize the widget. */
        #tsw {
            --ticket-shop-widget-main-color: #9152ff; /* Main color (buttons, links, etc.) */
            --ticket-shop-widget-active-color: #711fff; /* Active (clicked, focused) */
            --ticket-shop-widget-disabled-color: #9ca3af; /* Disabled element */
            --ticket-shop-font-family: "Sora", sans-serif; /* Specify a custom font family here */
            --ticket-shop-widget-button-font-weight: 700;
        }
        #tsw { font-family: var(--ticket-shop-font-family); border-color: transparent !important; }
        .pretix-widget-loading { position: relative }
        .pretix-widget-loading > svg { margin-top: 40px !important; }
        #tsw button { font-weight: var(--ticket-shop-widget-button-font-weight); }
        #tsw .pretix-widget-pricebox span { padding-top: .3em; display: inline-block; }
        #tsw .pretix-widget-waiting-list-link a { background-color: var(--ticket-shop-widget-main-color); font-weight: 700; display: block; margin-top: 0.75rem; text-decoration: none; font-size: 14px; padding: 6px 12px; line-height: 20px; color: white !important; border-radius: 3px; }
        #tsw .pretix-widget-waiting-list-link a:hover,
        #tsw .pretix-widget-waiting-list-link a:active { background-color: var(--ticket-shop-widget-active-color); }
        #tsw.sold-out .pretix-widget-voucher { display: none }
        #tsw.sold-out .pretix-widget-voucher-button-wrap button {
            background-color: var(--ticket-shop-widget-disabled-color);
            border-color: var(--ticket-shop-widget-disabled-color);
        }
        body:not(.tsw-widget-loaded) .pretix-widget-overlay { visibility: hidden !important; }

        /* Fee breakdown styles */
        #tsw .fees-breakdown {
            font-size: 0.9em;
            color: #666;
            margin: 24px 0 8px;
            width: 100%;
            text-align: right;
            display: flex;
            flex-direction: column;
            gap: 4px;
            max-width: 300px;
            margin-left: auto;
            margin-right: 48px;
        }
    </style>
    <script type="text/javascript" src="https://tickets-staging.conferenceconnect.com/widget/v1.en.js" async crossorigin></script>
    <script type="text/javascript">
        window.pretixWidgetCallback = function () {
            console.log('Widget callback initialized');

            // Function to calculate fees for total order using Pretix formula
            function calculateOrderFees(totalBasePrice) {
                const conferenceConnectFee = 5.00; // Fixed $5.00 fee per order
                const processingFeeFixed = 0.30; // $0.30
                const totalFixedFees = conferenceConnectFee + processingFeeFixed; // All fixed fees together
                const processingFeePercent = 2.9; // 2.9%

                // Using Pretix formula: ((price + fee_abs) * (1 / (1 - fee_percent / 100)) - price)
                const price = parseFloat(totalBasePrice);
                const totalWithFees = (price + totalFixedFees) * (1 / (1 - processingFeePercent / 100));
                const totalFees = totalWithFees - price;
                const processingFee = totalFees - conferenceConnectFee;

                return {
                    basePrice: price,
                    conferenceConnectFee: conferenceConnectFee,
                    processingFee: processingFee,
                    totalFees: totalFees,
                    totalPrice: totalWithFees
                };
            }

            // Function to update price display (simplified - just show original prices)
            function updatePriceDisplay() {
                console.log('updatePriceDisplay called');
                
                // Remove any existing fees breakdown from individual prices
                const existingFees = document.querySelectorAll('.fees-breakdown');
                existingFees.forEach(fee => fee.remove());
                
                // Update order total with fees
                updateOrderTotal();
            }

            // Function to get total order value
            function getTotalOrderValue() {
                let totalValue = 0;
                console.log('getTotalOrderValue called');
                
                // Find all ticket containers
                const ticketContainers = document.querySelectorAll('.pretix-widget-item');
                console.log('Found ticket containers:', ticketContainers.length);

                ticketContainers.forEach((container) => {
                    // Detectar si es un ticket de donación buscando un input de precio
                    const priceInput = container.querySelector('.pretix-widget-pricebox-price-input');
                    const quantityInput = container.querySelector('.pretix-widget-item-count-multiple');
                    
                    if (!quantityInput) return;
                    
                    const quantity = parseInt(quantityInput.value) || 0;
                    if (quantity === 0) return;

                    let price = 0;
                    
                    if (priceInput) {
                        // Es un ticket de donación, usar el valor ingresado
                        price = parseFloat(priceInput.value) || 0;
                        console.log('Donation ticket price:', price);
                    } else {
                        // Ticket normal, buscar el precio fijo
                        const priceElement = container.querySelector('[class*="price"]');
                        if (priceElement) {
                            const priceText = priceElement.textContent.trim();
                            const priceMatch = priceText.match(/[\d,.]+/);
                            if (priceMatch) {
                                price = parseFloat(priceMatch[0].replace(',', ''));
                            }
                        }
                        console.log('Fixed price ticket:', price);
                    }

                    console.log(`Item total (${price} * ${quantity}):`, price * quantity);
                    totalValue += price * quantity;
                });

                console.log('Total order value calculated:', totalValue);
                return totalValue;
            }

            // Function to update order total with fees
            function updateOrderTotal() {
                console.log('updateOrderTotal called');
                
                const totalValue = getTotalOrderValue();
                console.log('Total order value:', totalValue);
                
                if (totalValue > 0) {
                    const fees = calculateOrderFees(totalValue);
                    console.log('Calculating fees for order:', fees);
                    
                    // Find the total/order summary area - try multiple approaches
                    const totalSelectors = [
                        '.pretix-widget-total',
                        '.pretix-widget-summary',
                        '[class*="total"]',
                        '[class*="summary"]',
                        '.pretix-widget-pricebox',
                        '.pretix-widget-checkout',
                        '[class*="checkout"]',
                        '[class*="order"]'
                    ];
                    
                    let totalElement = null;
                    for (let selector of totalSelectors) {
                        const elements = document.querySelectorAll(selector);
                        console.log(`Selector "${selector}" found ${elements.length} elements`);
                        if (elements.length > 0) {
                            totalElement = elements[elements.length - 1]; // Use the last one
                            console.log(`Found total element with selector: ${selector}`);
                            break;
                        }
                    }
                    
                    // If no total element found, try to find the Buy button and insert before it
                    if (!totalElement) {
                        const buyButton = document.querySelector('button[class*="buy"], button[class*="checkout"], .pretix-widget-checkout button');
                        if (buyButton) {
                            console.log('Found buy button, will insert fees before it');
                            totalElement = buyButton.parentElement;
                        }
                    }
                    
                    // If still no element, try to find any container with the widget
                    if (!totalElement) {
                        const widgetContainer = document.getElementById('tsw');
                        if (widgetContainer) {
                            console.log('Using widget container as fallback');
                            totalElement = widgetContainer;
                        }
                    }
                    
                    if (totalElement) {
                        // Remove any existing fees breakdown
                        const existingFees = totalElement.querySelectorAll('.fees-breakdown');
                        existingFees.forEach(fee => fee.remove());
                        
                        const feesHtml = `
                            <div class="fees-breakdown" style="
                                font-size: 0.9em;
                                color: #666;
                                margin: 24px 0 8px;
                                width: 100%;
                                text-align: right;
                                display: flex;
                                flex-direction: column;
                                gap: 4px;
                                padding-right: 0;
                                max-width: 300px;
                                margin-left: auto;
                                margin-right: 48px;
                            ">
                                <div style="
                                    font-size: 1.1em;
                                    font-weight: 600;
                                    color: #333;
                                    margin-bottom: 4px;
                                    display: flex;
                                    justify-content: flex-end;
                                    align-items: center;
                                ">
                                    <span>Total with fees:</span>
                                    <span style="margin-left: 8px;">$${fees.totalPrice.toFixed(2)}</span>
                                </div>
                                <div style="
                                    display: flex;
                                    justify-content: flex-end;
                                    align-items: center;
                                    white-space: nowrap;
                                    font-size: 0.9em;
                                ">
                                    <span>Conference Connect hosting and processing fee:</span>
                                    <span style="margin-left: 8px;">$${fees.conferenceConnectFee.toFixed(2)}</span>
                                </div>
                                <div style="
                                    display: flex;
                                    justify-content: flex-end;
                                    align-items: center;
                                    white-space: nowrap;
                                    font-size: 0.9em;
                                ">
                                    <span>Credit Card processing fee:</span>
                                    <span style="margin-left: 8px;">$${fees.processingFee.toFixed(2)}</span>
                                </div>
                            </div>
                        `;
                        totalElement.insertAdjacentHTML('beforeend', feesHtml);
                        console.log('Added fees breakdown to element');
                    } else {
                        console.log('No suitable element found to display fees');
                    }
                } else {
                    // Remove any existing fees if total is 0
                    const existingFees = document.querySelectorAll('.fees-breakdown');
                    existingFees.forEach(fee => fee.remove());
                    console.log('Removed existing fees (total is 0)');
                }
            }

            // Set up event listeners for quantity and donation changes
            function setupQuantityListeners() {
                console.log('setupQuantityListeners called');
                
                // Find all quantity inputs and donation price inputs
                const quantityInputs = document.querySelectorAll('.pretix-widget-item-count-multiple');
                const donationInputs = document.querySelectorAll('.pretix-widget-pricebox-price-input');
                
                console.log('Found quantity inputs for listeners:', quantityInputs.length);
                console.log('Found donation inputs for listeners:', donationInputs.length);
                
                // Setup quantity input listeners
                quantityInputs.forEach((input, index) => {
                    console.log(`Setting up listeners for quantity input ${index}:`, input);
                    
                    // Remove existing listeners to avoid duplicates
                    input.removeEventListener('change', handleQuantityChange);
                    input.removeEventListener('input', handleQuantityChange);
                    
                    // Add new listeners
                    input.addEventListener('change', handleQuantityChange);
                    input.addEventListener('input', handleQuantityChange);
                });

                // Setup donation input listeners
                donationInputs.forEach((input, index) => {
                    console.log(`Setting up listeners for donation input ${index}:`, input);
                    
                    // Remove existing listeners to avoid duplicates
                    input.removeEventListener('change', handleQuantityChange);
                    input.removeEventListener('input', handleQuantityChange);
                    
                    // Add new listeners
                    input.addEventListener('change', handleQuantityChange);
                    input.addEventListener('input', handleQuantityChange);
                });
                
                // Find all quantity buttons (+ and -) using pretix-widget classes
                const quantityButtons = document.querySelectorAll('.pretix-widget-item-count-plus, .pretix-widget-item-count-minus, button[class*="plus"], button[class*="minus"]');
                console.log('Found quantity buttons for listeners:', quantityButtons.length);
                
                quantityButtons.forEach((button, index) => {
                    console.log(`Setting up listeners for button ${index}:`, button);
                    
                    // Remove existing listeners to avoid duplicates
                    button.removeEventListener('click', handleQuantityChange);
                    
                    // Add new listeners
                    button.addEventListener('click', handleQuantityChange);
                });
            }
            
            // Handler function
            function handleQuantityChange(event) {
                console.log('Quantity change detected:', event.type, event.target);
                setTimeout(() => {
                    console.log('Calling updateOrderTotal from quantity change');
                    updateOrderTotal();
                }, 100);
            }

            // Wait for the widget to be fully loaded and built
            window.PretixWidget.addLoadListener(function () {
                console.log('PretixWidget.addLoadListener called - widget is fully loaded');
                
                const $tsw = document.getElementById('tsw'); // Ticket Shop Widget
                if($tsw) {
                    const $isSoldOutNode = document.querySelector('.pretix-widget-availability-box .pretix-widget-availability-gone');
                    if(!!$isSoldOutNode) { $tsw.classList.add('sold-out'); }
                }
                
                // Wait a bit more for all elements to be rendered
                setTimeout(() => { 
                    console.log('Widget should be fully rendered now');
                    document.body.classList.add('tsw-widget-loaded'); 
                    updatePriceDisplay();
                }, 2000);
                
                // Set up observer to watch for dynamic content changes
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                            console.log('DOM mutation detected, updating fees');
                            setTimeout(updatePriceDisplay, 100);
                        }
                    });
                });
                
                // Start observing the widget container
                const widgetContainer = document.getElementById('tsw');
                if (widgetContainer) {
                    observer.observe(widgetContainer, { childList: true, subtree: true });
                    console.log('Started observing widget container for changes');
                }
                
                // Setup listeners after initial load
                setTimeout(setupQuantityListeners, 2500);
                
                // Also setup listeners periodically to catch dynamically added elements
                setInterval(() => {
                    setupQuantityListeners();
                }, 3000);
                
                // Polling to check for value changes as a fallback
                let lastValues = [0, 0, 0];
                setInterval(() => {
                    const quantityInputs = document.querySelectorAll('.pretix-widget-item-count-multiple, input[type="number"]');
                    let hasChanged = false;
                    
                    quantityInputs.forEach((input, index) => {
                        const currentValue = parseInt(input.value) || 0;
                        if (currentValue !== lastValues[index]) {
                            console.log(`Value changed for input ${index}: ${lastValues[index]} -> ${currentValue}`);
                            lastValues[index] = currentValue;
                            hasChanged = true;
                        }
                    });
                    
                    if (hasChanged) {
                        console.log('Calling updateOrderTotal from polling');
                        updateOrderTotal();
                    }
                }, 500);
            });
        }
    </script>
</head>
<body>
    <h1>Pretix Widget Demo</h1>
    <pretix-widget id="tsw" event="https://tickets-staging.conferenceconnect.com/conferenceconnect/restoring-pretix-test-2/" single-item-select="button"></pretix-widget>
    <noscript>
        <div id="pretix-widget-container">
            <div class="pretix-widget">
                <div class="pretix-widget-info-message">
                    JavaScript is disabled in your browser. To access our ticket shop without JavaScript, please 
                    <a target="_blank" rel="noopener" href="https://tickets-staging.conferenceconnect.com/conferenceconnect/restoring-pretix-test-2/">click here</a>.
                </div>
            </div>
        </div>
    </noscript>
</body>
</html>